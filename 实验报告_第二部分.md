## 4.2 基本HEAD、GET、POST方法的实现

### 协议实现

#### 1. HTTP请求验证模块

**流程图**：

```
开始
  |
  v
解析请求行 (方法、URI、版本)
  |
  v
检查方法是否全部大写
  |
  v
检查HTTP版本是否为HTTP/1.1
  |
  v
返回验证结果
  |
  v
结束
```

**伪代码**：

```
函数 validate_http_request(request, method, path, version):
    提取请求的第一行
    如果 无法解析请求行为三个部分 (方法、路径、版本) 则
        返回 0 // 无效请求
    结束如果

    对于 方法中的每个字符 执行
        如果 字符不是大写字母 则
            返回 0 // 无效请求
        结束如果
    结束对于

    如果 版本不是HTTP/1.1 则
        返回 -505 // 版本不支持
    结束如果

    返回 1 // 有效请求
结束函数
```

#### 2. 文件响应处理模块

**流程图**：

```
开始
  |
  v
尝试打开请求的文件
  |
  v
文件是否存在? ----否---> 返回404错误
  |
  是
  v
检查文件状态 ----不是常规文件---> 返回404错误
  |
  是常规文件
  v
构建HTTP响应头
  |
  v
发送HTTP响应头
  |
  v
方法是HEAD? ----是---> 返回200状态码
  |
  否
  v
读取并发送文件内容
  |
  v
返回200状态码
  |
  v
结束
```

**伪代码**：

```
函数 send_file_response(client_socket, method, file_path):
    fd = 打开文件(file_path, 只读模式)
    如果 fd < 0 则
        发送(client_socket, 404响应)
        返回 404
    结束如果

    获取文件状态(fd, &st)
    如果 不是常规文件 则
        关闭(fd)
        发送(client_socket, 404响应)
        返回 404
    结束如果

    构建HTTP响应头(header, st.st_size, mime_type)
    发送(client_socket, header)

    如果 method != "HEAD" 则
        循环读取文件内容并发送
    结束如果

    关闭(fd)
    返回 200
结束函数
```

#### 3. 客户端请求处理模块

**流程图**：

```
开始
  |
  v
接收客户端请求
  |
  v
请求大小是否合法? ----否---> 返回400错误
  |
  是
  v
验证HTTP请求
  |
  v
HTTP版本是否支持? ----否---> 返回505错误
  |
  是
  v
请求是否有效? ----否---> 返回400错误
  |
  是
  v
方法是否支持? ----否---> 返回501错误
  |
  是
  v
方法是POST? ----是---> 处理POST请求
  |
  否
  v
处理GET/HEAD请求
  |
  v
记录访问日志
  |
  v
关闭客户端连接
  |
  v
结束
```

**伪代码**：

```
函数 process_client_request(client_socket, client_addr):
    获取客户端IP地址
    接收客户端请求数据

    如果 请求大小超过限制 则
        发送400错误响应
        记录访问日志
        关闭连接
        返回
    结束如果

    解析HTTP请求(buffer, method, path, version)

    如果 HTTP版本不支持 则
        发送505错误响应
        记录访问日志
        关闭连接
        返回
    结束如果

    如果 请求无效 则
        发送400错误响应
        记录访问日志
        关闭连接
        返回
    结束如果

    如果 方法不支持 则
        发送501错误响应
        记录访问日志
        关闭连接
        返回
    结束如果

    如果 method == "POST" 则
        发送响应头
        发送请求内容作为响应
        记录访问日志
        关闭连接
        返回
    结束如果

    构建完整文件路径
    发送文件响应
    记录访问日志
    关闭连接
结束函数
```

#### 4. 主服务器循环

**流程图**：

```
开始
  |
  v
初始化日志系统
  |
  v
设置信号处理
  |
  v
创建服务器套接字
  |
  v
绑定地址和端口
  |
  v
开始监听连接
  |
  v
循环 {
    |
    v
    接受客户端连接
    |
    v
    处理客户端请求
}
  |
  v
关闭服务器套接字
  |
  v
结束
```

**伪代码**：

```
函数 main():
    初始化日志系统
    设置信号处理函数

    创建服务器套接字
    设置套接字选项
    绑定地址和端口
    开始监听连接

    循环 {
        接受客户端连接
        处理客户端请求(client_sock, client_addr)
    }

    关闭服务器套接字
    关闭日志系统
    返回成功
结束函数
```

#### 5. 日志记录模块实现

**流程图**：

```
开始
  |
  v
初始化日志文件
  |
  v
记录错误日志 -----> 写入错误日志文件
  |
  v
记录访问日志 -----> 写入访问日志文件
  |
  v
关闭日志文件
  |
  v
结束
```

**伪代码**：

```
函数 log_init(error_log_path, access_log_path):
    打开错误日志文件
    打开访问日志文件
    如果 打开失败 则
        返回错误
    结束如果
    返回成功
结束函数

函数 log_error(format, ...):
    获取当前时间
    格式化错误消息
    写入错误日志文件
结束函数

函数 log_access(client_ip, client_port, method, uri, version, status_code, content_length):
    获取当前时间
    格式化访问日志消息
    写入访问日志文件
结束函数

函数 log_close():
    关闭错误日志文件
    关闭访问日志文件
结束函数
```

#### 6. 错误处理模块实现

**流程图**：

```
开始
  |
  v
检测错误类型
  |
  v
400错误? ----是---> 发送400响应
  |
  否
  v
404错误? ----是---> 发送404响应
  |
  否
  v
501错误? ----是---> 发送501响应
  |
  否
  v
505错误? ----是---> 发送505响应
  |
  否
  v
记录错误日志
  |
  v
结束
```

**伪代码**：

```
函数 handle_error(client_socket, error_code, client_ip, method, path, version):
    如果 error_code == 400 则
        发送(client_socket, RESPONSE_400)
    否则如果 error_code == 404 则
        发送(client_socket, RESPONSE_404)
    否则如果 error_code == 501 则
        发送(client_socket, RESPONSE_501)
    否则如果 error_code == 505 则
        发送(client_socket, RESPONSE_505)
    结束如果

    记录访问日志(client_ip, method, path, version, error_code)
结束函数
```

# 3.2 Echo Web Server 的设计

## 1. 数据结构设计

### (1) HTTP请求解析结构（Request结构体）
```c
typedef struct {
    char http_method[16];    // HTTP方法
    char http_uri[1024];     // 请求URI
    char http_version[16];   // HTTP版本
    Header *headers;         // 请求头部链表
    int header_count;        // 头部字段数量
} Request;
```
功能：存储解析后的HTTP请求各个组成部分。
设计要点：
- 使用固定大小数组存储方法和版本，防止缓冲区溢出
- 通过链表结构存储可变数量的头部字段
- URI使用较大缓冲区以支持长路径

### (2) 缓冲区设计
```c
#define BUF_SIZE 4096
char buf[BUF_SIZE];
```
功能：接收和发送HTTP消息的临时存储区。
设计要点：
- 固定大小为4KB，平衡内存使用和请求处理能力
- 用于原始请求的接收和响应的构建
- 防止大请求导致的内存溢出

### (3) 预定义响应消息
```c
#define HTTP_400 "HTTP/1.1 400 Bad request\r\n\r\n"
#define HTTP_501 "HTTP/1.1 501 Not Implemented\r\n\r\n"
```
功能：定义标准错误响应格式。
设计要点：
- 符合HTTP/1.1规范的响应格式
- 包含状态行和必要的空行
- 简化错误处理流程

## 2. 协议规则设计

### (1) 请求处理流程

#### 请求接收与解析
```c
int bytes_received = recv(client_sock, buf, BUF_SIZE - 1, 0);
Request* request = parse(buf, bytes_received, client_sock);
```
处理规则：
- 限制单次接收数据大小
- 通过parse函数进行请求解析
- 返回NULL表示请求格式错误

#### 方法验证
```c
if (strcmp(request->http_method, "GET") != 0 && 
    strcmp(request->http_method, "HEAD") != 0 && 
    strcmp(request->http_method, "POST") != 0) {
    // 返回501
}
```
处理规则：
- 仅支持GET、HEAD、POST方法
- 其他方法返回501错误
- 方法名大小写敏感

### (2) 响应生成规则

#### 成功响应（200 OK）
```c
char* build_http_response(Request* request, char* original_request, 
                         int request_len, int* response_len) {
    // 构建响应头
    // 添加原始请求作为响应体
}
```
处理规则：
- 状态行：HTTP/1.1 200 OK
- 回显完整的原始请求内容
- 保持请求格式不变

#### 错误响应
- 400 Bad Request：请求格式错误或无法解析
- 501 Not Implemented：不支持的HTTP方法

### (3) 连接管理

#### 连接处理
```c
while (1) {
    client_sock = accept(sock, (struct sockaddr *) &cli_addr, &cli_size);
    // 处理单个请求
    close(client_sock);
}
```
设计特点：
- 单进程单线程模型
- 短连接模式（每次请求后关闭）
- 串行处理客户端请求

#### 错误处理
```c
void handle_signal(const int sig) {
    if (sock != -1) {
        close_socket(sock);
    }
    exit(0);
}
```
设计特点：
- 注册多种信号处理器
- 确保资源正确释放
- 处理异常终止情况

## 3. 安全性设计

### (1) 内存安全
- 使用固定大小缓冲区
- 请求大小限制
- 字符串操作边界检查

### (2) 资源管理
- 及时关闭套接字
- 释放动态分配的内存
- 处理连接异常中断

### (3) 错误处理
- 验证系统调用返回值
- 提供错误响应
- 日志记录关键操作
